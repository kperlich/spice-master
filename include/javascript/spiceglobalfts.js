/* * *******************************************************************************
* This file is part of SpiceCRM FulltextSearch. SpiceCRM FulltextSearch is an enhancement developed
* by aac services k.s.. All rights are (c) 2016 by aac services k.s.
*
* This Version of the SpiceCRM FulltextSearch is licensed software and may only be used in
* alignment with the License Agreement received with this Software.
* This Software is copyrighted and may not be further distributed without
* witten consent of aac services k.s.
*
* You can contact us at info@spicecrm.io
******************************************************************************* */

SpiceCRM.controller("GlobalFTSController",["$scope","GlobalFTSService",function(a,b){angular.extend(a,{globalFTSService:b,keyup:function(a){}}),a.$watch("globalFTSService.gloablSearchTerm",function(a,c){if((a||c)&&a!==c){b.getGlobalFTSSearchResults();var d=document.getElementById("query_string");d&&(d.value=a)}})}]),SpiceCRM.controller("GlobalFTSModuleItemController",["$scope","GlobalFTSService",function(a,b){angular.extend(a,{globalFTSService:b,setSearchModule:function(){this.globalFTSService.searchFiltermodule=this.menuItem,this.globalFTSService.getGlobalFTSModuleSearchResults()}})}]),SpiceCRM.directive("globalFtsModuleItem",[function(){return{restrict:"E",templateUrl:"include/SpiceFTSManager/tpls/globalFTSModuleItem.html",controller:"GlobalFTSModuleItemController",replace:!0,scope:{menuItem:"="}}}]),SpiceCRM.controller("GlobalFTSModulePanelController",["$scope","GlobalFTSService",function(a,b){angular.extend(a,{globalFTSService:b,loadMore:function(a){this.globalFTSService.getGlobalFTSMoreSearchResults(a)}})}]),SpiceCRM.directive("globalFtsModulePanel",[function(){return{restrict:"E",templateUrl:"include/SpiceFTSManager/tpls/globalFTSModulePanel.html",controller:"GlobalFTSModulePanelController",replace:!0,scope:{searchModule:"="}}}]),SpiceCRM.controller("GlobalFTSModulePanelHeaderController",["$scope","GlobalFTSService",function(a,b){angular.extend(a,{globalFTSService:b,getFieldStyle:function(a){return{width:a.width+"%"}}})}]),SpiceCRM.directive("globalFtsModulePanelHeader",[function(){return{restrict:"E",templateUrl:"include/SpiceFTSManager/tpls/globalFTSModuleHeader.html",controller:"GlobalFTSModulePanelHeaderController",replace:!0,scope:{searchModule:"="}}}]),SpiceCRM.controller("GlobalFTSModuleSearchItemController",["$scope","GlobalFTSService",function(a,b){angular.extend(a,{globalFTSService:b,getFieldStyle:function(a){return{width:a.width+"%"}},hasLink:function(a,b){var c=!1;return angular.forEach(this.globalFTSService.viewdefs[b._type],function(b){a.name.toUpperCase()==b.name.toUpperCase()&&b.link&&(c=!0)}),c},getLinkModule:function(a,b){if(b){var c=b._type;return angular.forEach(this.globalFTSService.viewdefs[b._type],function(b){a.name.toUpperCase()==b.name.toUpperCase()&&b.link&&b.linkmodule&&(c=b.linkmodule)}),c}},getLinkId:function(a,b){if(b){var c=b._id;return angular.forEach(this.globalFTSService.viewdefs[b._type],function(d){a.name.toUpperCase()==d.name.toUpperCase()&&d.link&&d.linkid&&(c=b._source[d.linkid.toLowerCase()])}),c}},getRecordValue:function(a,b){if(b&&b._source)return b._source[a.name.toLowerCase()]}})}]),SpiceCRM.directive("globalFtsModuleSearchItem",[function(){return{restrict:"E",templateUrl:"include/SpiceFTSManager/tpls/globalFTSModuleSearchItem.html",controller:"GlobalFTSModuleSearchItemController",replace:!0,scope:{searchModule:"=",searchRecord:"="}}}]),SpiceCRM.factory("GlobalFTSService",["$rootScope","$http","$q",function(a,b,c){var d={globalFTSSearchModules:[],viewdefs:{},gloablSearchTerm:"",globalSearchModules:[],globalSearchModuleLabels:[],globalSearchResults:{},searchFiltermodule:"all",getGlobalFTSSearchModules:function(){b({method:"GET",url:"KREST/fts/searchmodules"}).success(function(a){d.globalFTSSearchModules.push("all"),angular.forEach(a.modules,function(b){d.globalFTSSearchModules.push(b),d.globalSearchModules.push(b),d.viewdefs=a.viewdefs,d.globalSearchModuleLabels[b]=SUGAR.language.get("app_list_strings","moduleList")[b]}),d.globalSearchModuleLabels.all="All Modules",d.getGlobalFTSSearchResults()})},getGlobalFTSSearchResults:function(){"all"!==this.searchFiltermodule?this.getGlobalFTSModuleSearchResults():b({method:"GET",url:"KREST/fts/globalsearch/"+d.globalSearchModules.join()+(d.gloablSearchTerm?"/":"")+d.gloablSearchTerm}).success(function(b){d.globalSearchResults=b,a.$$phase||a.$apply()})},getGlobalFTSMoreSearchResults:function(a){b({method:"GET",url:"KREST/fts/globalsearch/"+a+(d.gloablSearchTerm?"/":"")+d.gloablSearchTerm+"?records=25&start="+d.globalSearchResults[a].hits.length}).success(function(b){d.globalSearchResults[a].hits=d.globalSearchResults[a].hits.concat(b[a].hits)})},getGlobalFTSModuleSearchResults:function(){"all"===this.searchFiltermodule?this.getGlobalFTSSearchResults():b({method:"GET",url:"KREST/fts/globalsearch/"+this.searchFiltermodule+(d.gloablSearchTerm?"/":"")+d.gloablSearchTerm+"?records=50&start=0"}).success(function(b){d.globalSearchResults=b,a.$$phase||a.$apply()})}};return d.gloablSearchTerm=document.getElementById("query_string").value,d.getGlobalFTSSearchModules(),d}]);