/* * *******************************************************************************
* This file is part of SpiceCRM FulltextSearch. SpiceCRM FulltextSearch is an enhancement developed
* by aac services k.s.. All rights are (c) 2016 by aac services k.s.
*
* This Version of the SpiceCRM FulltextSearch is licensed software and may only be used in
* alignment with the License Agreement received with this Software.
* This Software is copyrighted and may not be further distributed without
* witten consent of aac services k.s.
*
* You can contact us at info@spicecrm.io
******************************************************************************* */

Ext.define("SpiceCRM.QuotaManager.model.gridentry",{extend:"Ext.data.Model",alias:["widget.quotaModel"],fields:["id","name","p1","p2","p3","p4","p5","p6","p7","p8","p9","p10","p11","p12","total"]}),Ext.define("SpiceCRM.QuotaManager.model.quota",{extend:"Ext.data.Model",alias:["widget.quotaModel"],fields:["id","assigned_user_id","assigned_user_name","year","period","quota"]}),Ext.define("SpiceCRM.QuotaManager.model.user",{extend:"Ext.data.Model",alias:["widget.quotaModel"],fields:["id","name"]}),Ext.define("SpiceCRM.QuotaManager.store.gridentries",{extend:"Ext.data.Store",requires:["SpiceCRM.QuotaManager.model.gridentry"],model:"SpiceCRM.QuotaManager.model.gridentry",autoLoad:!1,proxy:{type:"memory"},loadYear:function(a){this.each(function(a){a.set({P1:"",P2:"",P3:"",P4:"",P5:"",P6:"",P7:"",P8:"",P9:"",P10:"",P11:"",P12:"",total:""})}),Ext.Ajax.request({url:"KREST/quotamanager/quotas/"+a,method:"GET",success:function(a,b){var c=Ext.decode(a.responseText);Ext.each(c,function(a){var b=this.getById(a.assigned_user_id);b&&b.set("P"+a.period,parseInt(a.sales_quota?a.sales_quota:0))},this),this.calculateTotal()},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this})},calculateTotal:function(){this.each(function(a){for(var b=0,c=1;c<=12;c++)b+=parseInt(a.get("P"+c)?a.get("P"+c):0);a.set("total",b)})}}),Ext.define("SpiceCRM.QuotaManager.store.quotas",{extend:"Ext.data.Store",requires:["SpiceCRM.QuotaManager.model.quota"],model:"SpiceCRM.QuotaManager.model.quota",autoLoad:!1,proxy:{type:"ajax",url:"KREST/quotamanager",reader:{type:"json"}}}),Ext.define("SpiceCRM.QuotaManager.store.users",{extend:"Ext.data.Store",requires:["SpiceCRM.QuotaManager.model.user"],model:"SpiceCRM.QuotaManager.model.user",autoLoad:!1,proxy:{type:"memory"}}),Ext.define("SpiceCRM.QuotaManager.controller.Application",{extend:"Ext.app.Controller",doInit:function(){console.log("app controller initialized")},finishInit:function(){},onLaunch:function(){},getReportId:function(){},createGuId:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0;return("x"==a?b:3&b|8).toString(16)})}}),Ext.define("SpiceCRM.QuotaManager.controller.MainController",{extend:"Ext.app.ViewController",requires:[],saving:!1,alias:"controller.QuotaManagerMain",config:{listen:{global:{}},control:{"#":{edit:function(a,b){b.value>0||0===b.value?Ext.Ajax.request({url:"KREST/quotamanager/quota/"+b.record.id+"/"+this.view.down("#yearSelector").getValue()+"/"+b.column.dataIndex.substring(1)+"/"+b.value,method:"POST",success:function(a,b){},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this}):Ext.Ajax.request({url:"KREST/quotamanager/quota/"+b.record.id+"/"+this.view.down("#yearSelector").getValue()+"/"+b.column.dataIndex.substring(1),method:"DELETE",success:function(a,b){},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this});for(var c=0,d=1;d<=12;d++)c+=parseInt(b.record.get("P"+d)?b.record.get("P"+d):0);b.record.set("total",c)}},"#yearSelector":{change:function(a,b){this.view.getStore().loadYear(b)}},"#userFilter":{specialkey:function(a,b){if(b.getKey()==b.ENTER){a.up("form").getForm().submit()}}}}}}),Ext.define("SpiceCRM.QuotaManager.view.main.Main",{extend:"Ext.container.Container",xtype:"app-main",renderTo:"quotamanager",height:"100%",width:"100%",border:!0,layout:"fit",items:[{xtype:"QuotaManager"}]}),Ext.define("SpiceCRM.QuotaManager.view.QuotaManager",{extend:"Ext.grid.Panel",alias:["widget.QuotaManager"],requires:["SpiceCRM.QuotaManager.controller.MainController"],height:"100%",width:"100%",border:!0,title:"Quota Manager",controller:"QuotaManagerMain",store:Ext.create("SpiceCRM.QuotaManager.store.gridentries",{storeId:"QuotaManagerGridEntriesStore"}),flex:1,columns:[{text:"Name",dataIndex:"name",flex:3,sortable:!1},{xtype:"numbercolumn",align:"right",text:"Total",dataIndex:"total",flex:1,sortable:!1},{xtype:"numbercolumn",align:"right",text:"Jan",dataIndex:"P1",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Feb",dataIndex:"P2",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Mar",dataIndex:"P3",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Apr",dataIndex:"P4",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"May",dataIndex:"P5",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Jun",dataIndex:"P6",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Jul",dataIndex:"P7",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Aug",dataIndex:"P8",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Sep",dataIndex:"P9",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Oct",dataIndex:"P10",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Nov",dataIndex:"P11",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}},{xtype:"numbercolumn",align:"right",text:"Dec",dataIndex:"P12",flex:1,sortable:!1,editor:{xtype:"numberfield",hideTrigger:!0}}],viewConfig:{stripeRows:!0,copy:!0,markDirty:!1},selModel:"rowmodel",plugins:{ptype:"cellediting",clicksToEdit:1},tbar:[{xtype:"combo",fieldLabel:"Year",typeAhead:!0,itemId:"yearSelector",triggerAction:"all",mode:"local",value:(new Date).getFullYear(),store:Ext.create("Ext.data.Store",{fields:["value","text"],data:[{value:"2015",text:"2015"},{value:"2016",text:"2016"},{value:"2017",text:"2017"},{value:"2018",text:"2018"},{value:"2019",text:"2019"},{value:"2020",text:"2020"},{value:"2021",text:"2021"},{value:"2022",text:"2022"},{value:"2023",text:"2023"}]}),valueField:"value",displayField:"text"}]}),Ext.define("SpiceCRM.QuotaManager.Application",{namespaces:["SpiceCRM.QuotaManager"],controllers:["Application"],extend:"Ext.app.Application",name:"SpiceCRM.QuotaManager",thisMainView:null,launch:function(){SpiceCRM.QuotaManager.Application=this,this.render()},render:function(){console.log("rendering"),this.thisMainView=Ext.create("SpiceCRM.QuotaManager.view.main.Main");var a=Ext.data.StoreManager.lookup("QuotaManagerGridEntriesStore");Ext.Ajax.request({url:"KREST/quotamanager/users",method:"GET",success:function(b,c){var d=Ext.decode(b.responseText);Ext.each(d,function(b){a.add({id:b.id,name:b.last_name+" "+b.first_name+" ("+b.user_name+")"})}),a.loadYear((new Date).getFullYear())},failure:function(a,b){console.log("server-side failure with status code "+a.status)},scope:this}),Ext.get(window).on({resize:function(){SpiceCRM.QuotaManager.Application.thisMainView&&SpiceCRM.QuotaManager.Application.thisMainView.updateLayout()}})},getRand:function(){return Math.random()},S4:function(){return(65536*(1+this.getRand())|0).toString(16).substring(1)},kGuid:function(){return"k"+this.S4()+this.S4()+this.S4()+this.S4()+this.S4()+this.S4()+this.S4()}}),Ext.application({extend:"SpiceCRM.QuotaManager.Application"}),Ext.onReady(function(){});